# CPU Manager Go - Prometheus Alerting Rules
# 
# Import this file into your Prometheus configuration or load via alertmanager.
# See: https://prometheus.io/docs/prometheus/latest/configuration/alerting_rules/
#
# Usage:
#   1. Copy this file to your Prometheus rules directory
#   2. Add to prometheus.yml:
#      rule_files:
#        - "/path/to/alerting-rules.yml"
#   3. Reload Prometheus: kill -HUP <pid>

groups:
  # ============================================================================
  # CRITICAL ALERTS - Immediate attention required
  # ============================================================================
  - name: cpu_manager_critical
    interval: 30s
    
    rules:
      # -------------------------------------------------------------------------
      # User CPU Critical
      # -------------------------------------------------------------------------
      - alert: CPUManagerUserCPUCritical
        expr: cpu_manager_user_cpu_usage_percent > 95
        for: 5m
        labels:
          severity: critical
          category: cpu
        annotations:
          summary: "User {{ $labels.username }} CPU usage critical"
          description: "User {{ $labels.username }} (UID: {{ $labels.uid }}) CPU usage is {{ $value | printf \"%.1f\" }}% for more than 5 minutes."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/cpu-critical.md"
          dashboard: "https://grafana.example.com/d/cpu-manager-dashboard"

      # -------------------------------------------------------------------------
      # User Memory Critical
      # -------------------------------------------------------------------------
      - alert: CPUManagerUserMemoryCritical
        expr: cpu_manager_user_memory_usage_bytes > 4294967296  # 4GB
        for: 10m
        labels:
          severity: critical
          category: memory
        annotations:
          summary: "User {{ $labels.username }} memory usage critical"
          description: "User {{ $labels.username }} (UID: {{ $labels.uid }}) is using {{ $value | humanize1024 }} of memory for more than 10 minutes."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/memory-critical.md"
          dashboard: "https://grafana.example.com/d/cpu-manager-dashboard"

      # -------------------------------------------------------------------------
      # System Overload
      # -------------------------------------------------------------------------
      - alert: CPUManagerSystemOverload
        expr: (cpu_manager_system_load_average / cpu_manager_cpu_total_cores) > 3
        for: 5m
        labels:
          severity: critical
          category: system
        annotations:
          summary: "System load critical"
          description: "System load per CPU core is {{ $value | printf \"%.2f\" }} (load: {{ $value | printf \"%.2f\" }}, cores: {{ $labels.instance }}) for more than 5 minutes."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/system-overload.md"

      # -------------------------------------------------------------------------
      # Too Many Processes
      # -------------------------------------------------------------------------
      - alert: CPUManagerTooManyProcesses
        expr: cpu_manager_user_process_count > 500
        for: 5m
        labels:
          severity: critical
          category: processes
        annotations:
          summary: "User {{ $labels.username }} has too many processes"
          description: "User {{ $labels.username }} (UID: {{ $labels.uid }}) has {{ $value }} processes running for more than 5 minutes."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/too-many-processes.md"

  # ============================================================================
  # WARNING ALERTS - Should be investigated soon
  # ============================================================================
  - name: cpu_manager_warnings
    interval: 30s
    
    rules:
      # -------------------------------------------------------------------------
      # User CPU High
      # -------------------------------------------------------------------------
      - alert: CPUManagerUserCPUHigh
        expr: cpu_manager_user_cpu_usage_percent > 75
        for: 10m
        labels:
          severity: warning
          category: cpu
        annotations:
          summary: "User {{ $labels.username }} CPU usage high"
          description: "User {{ $labels.username }} (UID: {{ $labels.uid }}) CPU usage is {{ $value | printf \"%.1f\" }}% for more than 10 minutes."
          dashboard: "https://grafana.example.com/d/cpu-manager-dashboard"

      # -------------------------------------------------------------------------
      # User Memory High
      # -------------------------------------------------------------------------
      - alert: CPUManagerUserMemoryHigh
        expr: cpu_manager_user_memory_usage_bytes > 2147483648  # 2GB
        for: 15m
        labels:
          severity: warning
          category: memory
        annotations:
          summary: "User {{ $labels.username }} memory usage high"
          description: "User {{ $labels.username }} (UID: {{ $labels.uid }}) is using {{ $value | humanize1024 }} of memory for more than 15 minutes."
          dashboard: "https://grafana.example.com/d/cpu-manager-dashboard"

      # -------------------------------------------------------------------------
      # Memory Growth Rate
      # -------------------------------------------------------------------------
      - alert: CPUManagerMemoryGrowthRate
        expr: irate(cpu_manager_user_memory_usage_bytes[5m]) * 60 > 524288000  # 500MB/min
        for: 10m
        labels:
          severity: warning
          category: memory
        annotations:
          summary: "User {{ $labels.username }} memory growing rapidly"
          description: "User {{ $labels.username }} (UID: {{ $labels.uid }}) memory is growing at {{ $value | humanize1024 }}/min. Possible memory leak."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/memory-leak.md"

      # -------------------------------------------------------------------------
      # Process Count High
      # -------------------------------------------------------------------------
      - alert: CPUManagerProcessCountHigh
        expr: cpu_manager_user_process_count > 200
        for: 10m
        labels:
          severity: warning
          category: processes
        annotations:
          summary: "User {{ $labels.username }} process count high"
          description: "User {{ $labels.username }} (UID: {{ $labels.uid }}) has {{ $value }} processes running."
          dashboard: "https://grafana.example.com/d/cpu-manager-dashboard"

      # -------------------------------------------------------------------------
      # System Load High
      # -------------------------------------------------------------------------
      - alert: CPUManagerSystemLoadHigh
        expr: (cpu_manager_system_load_average / cpu_manager_cpu_total_cores) > 1.5
        for: 10m
        labels:
          severity: warning
          category: system
        annotations:
          summary: "System load high"
          description: "System load per CPU core is {{ $value | printf \"%.2f\" }} for more than 10 minutes."
          dashboard: "https://grafana.example.com/d/cpu-manager-dashboard"

  # ============================================================================
  # OPERATIONAL ALERTS - Service health monitoring
  # ============================================================================
  - name: cpu_manager_operations
    interval: 30s
    
    rules:
      # -------------------------------------------------------------------------
      # Limits Not Activating
      # -------------------------------------------------------------------------
      - alert: CPUManagerLimitsNotActivating
        expr: cpu_manager_cpu_user_usage_percent > 80 and cpu_manager_limits_active == 0
        for: 5m
        labels:
          severity: warning
          category: operations
        annotations:
          summary: "CPU limits not activating despite high usage"
          description: "User CPU usage is {{ $value | printf \"%.1f\" }}% but CPU limits are not active. Check configuration."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/limits-not-activating.md"

      # -------------------------------------------------------------------------
      # Frequent Limit Toggling
      # -------------------------------------------------------------------------
      - alert: CPUManagerFrequentLimitToggling
        expr: increase(cpu_manager_limits_activated_total[10m]) > 5
        for: 0m
        labels:
          severity: warning
          category: operations
        annotations:
          summary: "CPU limits toggling frequently"
          description: "CPU limits have been activated {{ $value }} times in the last 10 minutes. Check threshold configuration."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/frequent-toggling.md"

      # -------------------------------------------------------------------------
      # Control Cycle Too Slow
      # -------------------------------------------------------------------------
      - alert: CPUManagerControlCycleSlow
        expr: (rate(cpu_manager_control_cycle_duration_seconds_sum[5m]) / rate(cpu_manager_control_cycle_duration_seconds_count[5m])) > 10
        for: 5m
        labels:
          severity: warning
          category: performance
        annotations:
          summary: "CPU Manager control cycle too slow"
          description: "Average control cycle duration is {{ $value | printf \"%.1f\" }} seconds. Expected < 10 seconds."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/slow-control-cycle.md"

      # -------------------------------------------------------------------------
      # High Error Rate
      # -------------------------------------------------------------------------
      - alert: CPUManagerHighErrorRate
        expr: increase(cpu_manager_errors_total[5m]) > 10
        for: 0m
        labels:
          severity: warning
          category: errors
        annotations:
          summary: "CPU Manager error rate high"
          description: "{{ $value }} errors in the last 5 minutes. Check logs for details."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/high-error-rate.md"

      # -------------------------------------------------------------------------
      # Service Down
      # -------------------------------------------------------------------------
      - alert: CPUManagerServiceDown
        expr: absent(up{job="cpu-manager"} == 1)
        for: 1m
        labels:
          severity: critical
          category: availability
        annotations:
          summary: "CPU Manager service is down"
          description: "CPU Manager service has been down for more than 1 minute."
          runbook_url: "https://github.com/fdefilippo/cpu-manager-go/blob/main/docs/runbooks/service-down.md"

  # ============================================================================
  # INFO ALERTS - Informational notifications
  # ============================================================================
  - name: cpu_manager_info
    interval: 60s
    
    rules:
      # -------------------------------------------------------------------------
      # New Active User
      # -------------------------------------------------------------------------
      - alert: CPUManagerNewActiveUser
        expr: changes(cpu_manager_active_users_count[5m]) > 0
        for: 0m
        labels:
          severity: info
          category: operations
        annotations:
          summary: "Active users count changed"
          description: "Number of active users changed. Current count: {{ $value }}."

      # -------------------------------------------------------------------------
      # Limits Activated
      # -------------------------------------------------------------------------
      - alert: CPUManagerLimitsActivated
        expr: changes(cpu_manager_limits_active[5m]) == 1
        for: 0m
        labels:
          severity: info
          category: operations
        annotations:
          summary: "CPU limits activated"
          description: "CPU limits have been activated due to high user CPU usage."

      # -------------------------------------------------------------------------
      # Limits Deactivated
      # -------------------------------------------------------------------------
      - alert: CPUManagerLimitsDeactivated
        expr: changes(cpu_manager_limits_active[5m]) == -1
        for: 0m
        labels:
          severity: info
          category: operations
        annotations:
          summary: "CPU limits deactivated"
          description: "CPU limits have been deactivated. User CPU usage is now within normal range."

# ============================================================================
# INHIBITION RULES (for Alertmanager)
# ============================================================================
# Add these to your alertmanager.yml:
#
# inhibit_rules:
#   # If critical CPU alert is firing, suppress warning CPU alert
#   - source_match:
#       severity: 'critical'
#     target_match:
#       severity: 'warning'
#     equal: ['alertname', 'uid']
#
#   # If service is down, suppress all other alerts
#   - source_match:
#       alertname: 'CPUManagerServiceDown'
#     target_match_re:
#       alertname: '.+'
#     equal: ['instance']
