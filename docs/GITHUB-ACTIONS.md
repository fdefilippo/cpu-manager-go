# GitHub Actions Workflows Documentation

This document describes the CI/CD workflows configured for CPU Manager Go.

## Overview

The project uses GitHub Actions for continuous integration and deployment with automated testing, building, and release management.

---

## Workflows

### 1. **CI (ci.yml)** - Main CI/CD Pipeline

**Trigger**: Push, Pull Request to `main`/`develop` branches, Tags

**Jobs**:

| Job | Description | Go Versions |
|-----|-------------|-------------|
| **test** | Run unit tests with coverage | 1.21, 1.22, 1.23 |
| **lint** | Code quality checks | 1.23 |
| **build** | Multi-platform binaries | 1.23 |
| **package** | **RPM & DEB packages** | 1.23 |
| **security** | Vulnerability scanning | 1.23 |
| **release** | GitHub release (tags only) | 1.23 |
| **notify** | Notifications | - |

**Features**:
- ✅ Parallel test execution on multiple Go versions
- ✅ Race detector enabled
- ✅ Coverage report generation
- ✅ **RPM package build** (source tarball + spec file)
- ✅ **DEB package build** (via Makefile)
- ✅ Automatic release on tags with packages
- ✅ Security scanning (govulncheck, gosec)

**Outputs**:
- Test coverage reports (HTML + XML)
- Binary artifacts (linux/amd64, linux/arm64)
- **RPM packages** (`~/rpmbuild/RPMS/*/*.rpm`)
- **DEB packages** (`build/deb/*.deb`)
- Security scan results

---

### 2. **Test Coverage (test-coverage.yml)** - Coverage Reporting

**Trigger**: Push to `main`/`develop`, Pull Requests

**Purpose**: Generate detailed coverage reports and post to PRs

**Features**:
- ✅ Overall coverage percentage
- ✅ Per-package coverage breakdown
- ✅ HTML coverage report
- ✅ Automatic PR comments with coverage stats
- ✅ Upload to Codecov.io

**Artifacts**:
- `coverage.out` - Raw coverage data
- `coverage.html` - Interactive HTML report
- `coverage-summary.md` - Markdown summary

**Example Output**:
```markdown
# Coverage Report

## Overall Coverage
```
ok    github.com/fdefilippo/cpu-manager-go/config    68.5%
ok    github.com/fdefilippo/cpu-manager-go/logging   72.3%
ok    github.com/fdefilippo/cpu-manager-go/metrics   45.8%
ok    github.com/fdefilippo/cpu-manager-go/reloader  85.7%
ok    github.com/fdefilippo/cpu-manager-go/state     42.1%
ok    github.com/fdefilippo/cpu-manager-go/cgroup    15.2%
```
```

---

### 3. **Docker (docker.yml)** - Container Build & Publish

**Trigger**: Push to `main`, Tags, Manual

**Purpose**: Build and publish Docker images

**Features**:
- ✅ Multi-architecture builds (amd64, arm64, arm/v7)
- ✅ Push to GitHub Container Registry (ghcr.io)
- ✅ Vulnerability scanning with Trivy
- ✅ Semantic versioning tags
- ✅ Build cache optimization

**Images Published**:
- `ghcr.io/fdefilippo/cpu-manager-go:latest`
- `ghcr.io/fdefilippo/cpu-manager-go:<version>`
- `ghcr.io/fdefilippo/cpu-manager-go:<sha>`

---

### 4. **Changelog Check (changelog.yml)** - PR Validation

**Trigger**: Pull Request

**Purpose**: Ensure CHANGELOG.md is updated for PRs

**Features**:
- ✅ Checks if CHANGELOG.md was modified
- ✅ Skip label support (`no-changelog`)
- ✅ Automatic PR comments
- ✅ Format validation

---

## Test Coverage

### Test Packages

| Package | Tests | Coverage | Description |
|---------|-------|----------|-------------|
| `config` | 11 | 68.5% | Configuration loading & validation |
| `metrics` | 16 | 45.8% | Metrics collection & Prometheus export |
| `logging` | 13 | 72.3% | Logger with rotation & syslog |
| `cgroup` | 14 | 15.2% | Cgroups v2 management |
| `reloader` | 4 | 85.7% | Configuration hot-reload |
| `state` | 18 | 42.1% | Control cycle & decision logic |

**Total**: 76 tests across 6 packages

### Running Tests Locally

```bash
# All tests
go test ./...

# With coverage
go test ./... -cover

# HTML coverage report
go test ./... -coverprofile=coverage.out
go tool cover -html=coverage.out

# Verbose output
go test ./... -v

# Race detector
go test ./... -race
```

---

## Badges

Add these badges to your README:

```markdown
[![CI](https://github.com/fdefilippo/cpu-manager-go/actions/workflows/ci.yml/badge.svg)](https://github.com/fdefilippo/cpu-manager-go/actions/workflows/ci.yml)
[![Test Coverage](https://github.com/fdefilippo/cpu-manager-go/actions/workflows/test-coverage.yml/badge.svg)](https://github.com/fdefilippo/cpu-manager-go/actions/workflows/test-coverage.yml)
```

---

## Configuration

### Required Secrets

| Secret | Description | Required For |
|--------|-------------|--------------|
| `CODECOV_TOKEN` | Codecov.io upload token | Coverage reporting |
| `GITHUB_TOKEN` | Auto-generated by GitHub | All workflows |
| `DOCKER_USERNAME` | Docker Hub username | Docker publishing (optional) |
| `DOCKER_PASSWORD` | Docker Hub password | Docker publishing (optional) |
| `SLACK_WEBHOOK_URL` | Slack webhook for notifications | Slack alerts (optional) |

### Matrix Testing

Tests run on multiple Go versions:
- **Go 1.21** - Minimum supported version
- **Go 1.22** - Previous stable
- **Go 1.23** - Latest stable

---

## Artifacts

### Retention

| Artifact Type | Retention Period |
|--------------|------------------|
| Test results | 7 days |
| Coverage reports | 30 days |
| Release binaries | Permanent (GitHub Releases) |
| Docker images | Permanent (GHCR) |

### Download

Artifacts can be downloaded from:
1. GitHub Actions run summary page
2. Releases page (for release builds)
3. Package registry (for Docker images)

---

## Troubleshooting

### Tests Failing

1. Check test output in Actions tab
2. Download test artifacts for detailed logs
3. Run tests locally: `go test ./... -v`

### Coverage Low

1. Generate HTML report: `go tool cover -html=coverage.out`
2. Identify uncovered lines
3. Add tests for critical paths

### Build Failures

1. Check Go version compatibility
2. Verify dependencies: `go mod verify`
3. Clean build: `go clean -cache && go build -v ./...`

---

## Best Practices

### For Contributors

1. **Run tests before pushing**: `go test ./...`
2. **Check coverage**: Aim for >70% on new code
3. **Update CHANGELOG**: Required for PRs (unless labeled)
4. **Follow commit conventions**: Use conventional commits

### For Maintainers

1. **Review coverage reports**: Check PR comments
2. **Monitor test trends**: Watch for coverage drops
3. **Tag releases**: Triggers automated release workflow
4. **Keep dependencies updated**: Run `go mod tidy` regularly

---

## Workflow Files

```
.github/workflows/
├── ci.yml                 # Main CI/CD pipeline
├── test-coverage.yml      # Coverage reporting
├── docker.yml             # Docker builds
└── changelog.yml          # Changelog validation
```

---

## External Integrations

| Service | Purpose | Configuration |
|---------|---------|---------------|
| **Codecov** | Coverage tracking | `.github/workflows/ci.yml` |
| **GitHub Packages** | Container registry | `.github/workflows/docker.yml` |
| **GitHub Releases** | Release artifacts | `.github/workflows/ci.yml` |

---

## Performance

### Typical Run Times

| Workflow | Average Duration |
|----------|-----------------|
| CI (full) | 10-15 minutes |
| Test Coverage | 5-7 minutes |
| Docker Build | 8-12 minutes |
| Changelog Check | 1-2 minutes |

### Optimization Tips

1. **Cache dependencies**: Enabled via `actions/cache`
2. **Parallel jobs**: Tests run in parallel across Go versions
3. **Concurrent builds**: Build and test run simultaneously
4. **Artifact compression**: Use zip/tar for large artifacts

---

*Last updated: February 2026*
