# Changelog Check Workflow
#
# Ensures CHANGELOG.md is updated for PRs

name: Changelog Check

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened, labeled, unlabeled]

jobs:
  changelog:
    name: Check Changelog
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if CHANGELOG.md was modified
        id: changelog_modified
        run: |
          if git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} | grep -q "CHANGELOG.md"; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check for skip label
        id: skip_label
        run: |
          if [[ "${{ contains(github.event.pull_request.labels.*.name, 'no-changelog') }}" == "true" ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR if changelog not updated
        if: steps.changelog_modified.outputs.changed == 'false' && steps.skip_label.outputs.skip == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## ⚠️ Changelog Missing\n\nPlease update `CHANGELOG.md` with your changes.\n\nIf this PR does not require a changelog entry, add the `no-changelog` label.'
            })
      
      - name: Fail if changelog not updated
        if: steps.changelog_modified.outputs.changed == 'false' && steps.skip_label.outputs.skip == 'false'
        run: |
          echo "ERROR: CHANGELOG.md was not modified"
          echo "Please add a changelog entry describing your changes."
          exit 1
      
      - name: Validate CHANGELOG.md format
        if: steps.changelog_modified.outputs.changed == 'true'
        run: |
          # Check for required sections
          if ! grep -q "^## \[" CHANGELOG.md; then
            echo "ERROR: CHANGELOG.md missing version sections"
            exit 1
          fi
          
          # Check for common sections
          if ! grep -q "### Added\|### Changed\|### Fixed\|### Removed" CHANGELOG.md; then
            echo "WARNING: CHANGELOG.md might be missing standard sections"
          fi
          
          echo "CHANGELOG.md validation passed"
