# GitHub Actions CI/CD Workflow for CPU Manager Go
# 
# This workflow:
# - Runs on every push and pull request
# - Tests on multiple Go versions
# - Builds binaries for multiple platforms
# - Uploads artifacts for download

name: CI

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

# Cancel previous runs if new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # Test Job - Run unit tests
  # ============================================================================
  test:
    name: Test
    runs-on: ubuntu-latest

    strategy:
      matrix:
        go: ['1.21', '1.22', '1.23']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go }}
          cache: true

      - name: Download dependencies
        run: |
          go mod download
          go mod verify

      - name: Build
        run: go build -v ./...

      - name: Run tests with coverage
        run: |
          go test -v -race -coverprofile=coverage.out ./... 2>&1 | tee test-output.txt
          go test ./... -coverprofile=coverage.out
          go tool cover -html=coverage.out -o coverage.html

      - name: Show test summary
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          go test ./... -cover >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-go-${{ matrix.go }}
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-go-${{ matrix.go }}
          path: |
            coverage.out
            coverage.html
            test-output.txt
          retention-days: 7
        continue-on-error: true

  # ============================================================================
  # Lint Job - Code quality checks
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true
      
      - name: Install golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: latest
          args: --timeout=5m
      
      - name: Run go vet
        run: go vet ./...
      
      - name: Check go mod tidy
        run: |
          go mod tidy
          git diff --exit-code go.mod go.sum || \
            (echo "go.mod/go.sum not tidy, please run 'go mod tidy'" && exit 1)
      
      - name: Check formatting
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "The following files are not formatted:"
            echo "$unformatted"
            exit 1
          fi

  # ============================================================================
  # Build Job - Create binaries for multiple platforms
  # ============================================================================
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [test, lint]
    
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: linux
            arch: arm
            arm: 7
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true
      
      - name: Build binary
        run: |
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }}${{ matrix.arm && ' GOARM=' || '' }}${{ matrix.arm }} \
          go build -v -ldflags="-s -w -X 'main.version=${{ github.sha }}'" \
          -o cpu-manager-go-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.arm && 'v' || '' }}${{ matrix.arm }}
      
      - name: Upload binary artifact
        uses: actions/upload-artifact@v4
        with:
          name: cpu-manager-go-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.arm && 'v' || '' }}${{ matrix.arm }}
          path: cpu-manager-go-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.arm && 'v' || '' }}${{ matrix.arm }}
          retention-days: 30

  # ============================================================================
  # Package Job - Create RPM and DEB packages
  # ============================================================================
  package:
    name: Package
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Install RPM build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y rpm rpmbuild dpkg-dev

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cpu-manager-go-linux-*
          merge-multiple: true
          path: build/

      - name: Make binaries executable
        run: chmod +x build/cpu-manager-go-*

      - name: Build RPM package
        run: |
          # Setup RPM build environment
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          
          # Copy spec file
          cp packaging/rpm/cpu-manager-go.spec ~/rpmbuild/SPECS/
          
          # Create source tarball
          tar -czf ~/rpmbuild/SOURCES/cpu-manager-go-${{ github.ref_name }}.tar.gz \
            --transform 's,^,cpu-manager-go-${{ github.ref_name }}/,' \
            *.go go.mod go.sum \
            config/ cgroup/ metrics/ state/ logging/ reloader/ \
            README.md LICENSE CHANGELOG.md \
            docs/*.md docs/*.json docs/*.yml docs/*.sh \
            packaging/
          
          # Build RPM
          rpmbuild -ba ~/rpmbuild/SPECS/cpu-manager-go.spec \
            --define "version ${GITHUB_REF_NAME#v}" \
            --define "release 1" \
            --define "_topdir $HOME/rpmbuild" || true
        continue-on-error: true

      - name: Build DEB package
        run: |
          # Build Debian package
          make deb-binary
          make deb-prepare
          make deb || true
        continue-on-error: true

      - name: Upload RPM artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: rpm-package-${{ github.run_id }}
          path: |
            ~/rpmbuild/RPMS/*/*.rpm
            ~/rpmbuild/SRPMS/*.rpm
          retention-days: 30
          if-no-files-found: ignore
        continue-on-error: true

      - name: Upload DEB artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: deb-package-${{ github.run_id }}
          path: build/deb/*.deb
          retention-days: 30
          if-no-files-found: ignore
        continue-on-error: true

      - name: Show package info
        run: |
          echo "## Package Build Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RPM Packages" >> $GITHUB_STEP_SUMMARY
          ls -lh ~/rpmbuild/RPMS/*/*.rpm 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No RPM packages built" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DEB Packages" >> $GITHUB_STEP_SUMMARY
          ls -lh build/deb/*.deb 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No DEB packages built" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Security Scan Job - Check for vulnerabilities
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true
      
      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest
      
      - name: Run vulnerability scan
        run: govulncheck ./...
        continue-on-error: true
      
      - name: Run gosec security scanner
        uses: securego/gosec@master
        with:
          args: ./...
        continue-on-error: true

  # ============================================================================
  # Release Job - Create GitHub Release
  # ============================================================================
  release:
    name: Release
    runs-on: ubuntu-latest
    needs: [test, lint, build, package, security]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: true

      - name: Create release notes
        run: |
          echo "# Release ${{ github.ref_name }}" > release-notes.md
          echo "" >> release-notes.md
          echo "## Changes" >> release-notes.md
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" >> release-notes.md || true
          echo "" >> release-notes.md
          echo "## Installation" >> release-notes.md
          echo "" >> release-notes.md
          echo "### RPM" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "rpm -ivh cpu-manager-go-*.rpm" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          echo "" >> release-notes.md
          echo "### DEB" >> release-notes.md
          echo "\`\`\`bash" >> release-notes.md
          echo "dpkg -i cpu-manager-go_*.deb" >> release-notes.md
          echo "\`\`\`" >> release-notes.md
          echo "" >> release-notes.md
          echo "## Package Contents" >> release-notes.md
          echo "" >> release-notes.md
          echo "- Binario cpu-manager-go" >> release-notes.md
          echo "- File di configurazione esempio" >> release-notes.md
          echo "- Systemd service" >> release-notes.md
          echo "- Man page (cpu-manager.8.gz)" >> release-notes.md
          echo "- Documentazione completa (TLS, Prometheus, Grafana)" >> release-notes.md
          echo "- Script generazione certificati TLS" >> release-notes.md
          echo "- Dashboard Grafana preconfigurato" >> release-notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/cpu-manager-go-*
            artifacts/*.rpm
            artifacts/*.deb
            release-notes.md
          body_path: release-notes.md
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload release assets summary
        run: |
          echo "## Release Assets" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Binaries" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/cpu-manager-go-* 2>/dev/null >> $GITHUB_STEP_SUMMARY || true
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### RPM Packages" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/*.rpm 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No RPM packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### DEB Packages" >> $GITHUB_STEP_SUMMARY
          ls -lh artifacts/*.deb 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "No DEB packages" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # Notify Job - Send notifications
  # ============================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [test, lint, build, package, security, release]
    if: always()
    
    steps:
      - name: Check job status
        run: |
          echo "Workflow completed with status: ${{ needs.test.result }}"
          echo "Test: ${{ needs.test.result }}"
          echo "Lint: ${{ needs.lint.result }}"
          echo "Build: ${{ needs.build.result }}"
          echo "Package: ${{ needs.package.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Release: ${{ needs.release.result }}"
      
      # Optional: Send Slack/Discord notification
      # - name: Notify Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "CPU Manager Go CI/CD completed",
      #         "blocks": [...]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
