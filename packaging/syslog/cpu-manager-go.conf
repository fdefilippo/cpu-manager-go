# File: /etc/rsyslog.d/cpu-manager-go-advanced.conf

# Configurazione avanzata per cpu-manager-go con supporto journald
module(load="imjournal" StateFile="imjournal.state")
module(load="omfile")

# Template migliorato per i log
template(name="CpuManagerJsonFormat" type="list") {
    constant(value="{")
    constant(value="\"timestamp\":\"")
    property(name="timereported" dateFormat="rfc3339")
    constant(value="\",\"host\":\"")
    property(name="hostname")
    constant(value="\",\"tag\":\"cpu-manager-go\",\"severity\":\"")
    property(name="syslogseverity-text")
    constant(value="\",\"message\":\"")
    property(name="msg")
    constant(value="\"}\n")
}

# Template semplice (legacy)
template(name="CpuManagerSimpleFormat" type="string"
         string="%timegenerated% %hostname% cpu-manager-go[%procid%]: %syslogseverity-text%: %msg%\n")

# Filtra i log di cpu-manager-go da pi√π sorgenti
if ($programname == 'cpu-manager-go') or
   ($syslogtag startswith 'cpu-manager-go') or
   ($msg contains '"appname":"cpu-manager-go"') then {

    # Log in formato JSON (opzionale)
    # action(type="omfile"
    #        file="/var/log/cpu-manager-go.json"
    #        template="CpuManagerJsonFormat"
    #        fileCreateMode="0640")

    # Log in formato testo semplice
    action(type="omfile"
           file="/var/log/cpu-manager.log"
           template="CpuManagerSimpleFormat"
           fileCreateMode="0640"
           dirCreateMode="0755"
           createDirs="on"
           asyncWriting="on"
           flushInterval="1")

    # Interrompi l'elaborazione per evitare duplicati
    stop
}
